import{Vector2}from"./vector2.js";export class Boid{constructor(i,t,e){this.position=Vector2.Zero,this.velocity=Vector2.Zero,this.acceleration=Vector2.Zero,this.visibleRadius=0,this.protectedRadius=0,this.avoidCoefficient=0,this.separateCoefficent=0,this.alignCoefficient=0,this.cohereCoefficient=0;const o=2*Math.PI*Math.random();this.position=new Vector2(i,t),this.velocity=new Vector2(Math.cos(o),Math.sin(o)),this.applySettings(e)}avoidObstacles(i){const t=this.position.add(this.velocity.normalized().multiplyS(120));for(const e of i){const i=e.getPosition(),o=e.getRadius(),s=t.distanceTo(i);if(s<o){const e=(o-s)/o,n=t.subtract(i).normalized().multiplyS(e*this.avoidCoefficient);this.acceleration=this.acceleration.add(n)}}}align(i,t,e){let o=Vector2.Zero,s=0;for(const i of e){if(i===this)continue;this.position.distanceTo(i.position)<this.visibleRadius&&(o=o.add(i.position),s++)}if(0===s)return;o=o.divideS(s),o.setMagnitude(i);let n=o.subtract(this.velocity);n.limitMagnitude(t),n=n.multiplyS(this.alignCoefficient),this.acceleration=this.acceleration.add(n)}separate(i,t,e){let o=Vector2.Zero,s=0;for(const i of e){if(i===this)continue;const t=this.position.distanceTo(i.getPosition());if(t<this.protectedRadius){let e=this.position.subtract(i.getPosition());e=e.divideS(t*t),o=o.add(e),s++}}if(0===s)return;o=o.divideS(s),o.setMagnitude(i);let n=o.subtract(this.velocity);n.limitMagnitude(t),n=n.multiplyS(this.separateCoefficent),this.acceleration=this.acceleration.add(n)}cohere(i,t,e){let o=Vector2.Zero,s=0;for(const i of e){if(i===this)continue;this.position.distanceTo(i.getPosition())<this.visibleRadius&&(o=o.add(i.getPosition()),s++)}if(0===s)return;o=o.divideS(s);let n=o.subtract(this.position);n.setMagnitude(i);let a=n.subtract(this.velocity);a.limitMagnitude(t),a=a.multiplyS(this.cohereCoefficient),this.acceleration.add(a)}wrapAroundCanvas(i,t){this.position.x<0?this.position.x=i:this.position.x>i&&(this.position.x=0),this.position.y<0?this.position.y=t:this.position.y>t&&(this.position.y=0)}applySettings(i){this.visibleRadius=i.getVisibleRadius(),this.protectedRadius=i.getProtectedRadius(),this.avoidCoefficient=i.getAvoidRepulsionStrength(),this.separateCoefficent=i.getSeparateCoefficient(),this.alignCoefficient=i.getAlignCoefficient(),this.cohereCoefficient=i.getCohereCoefficient()}update(i,t,e,o,s,n){this.acceleration=Vector2.Zero,this.align(e,o,i),this.separate(e,o,i),this.cohere(e,o,i),this.avoidObstacles(t),this.wrapAroundCanvas(s,n),this.position=this.position.add(this.velocity),this.velocity=this.velocity.add(this.acceleration),this.velocity.limitMagnitude(e)}render(i,t){let e=this.velocity.normalized().multiplyS(i.getBoidSize()),o=new Vector2(-e.y,e.x),s=new Vector2(e.y,-e.x);o=o.divideS(i.getBoidSize()/3),s=s.divideS(i.getBoidSize()/3),t.beginPath(),t.moveTo(this.position.x,this.position.y),t.lineTo(this.position.x+o.x,this.position.y+o.y),t.lineTo(this.position.x+e.x,this.position.y+e.y),t.lineTo(this.position.x+s.x,this.position.y+s.y),t.lineTo(this.position.x,this.position.y),t.lineWidth=i.getBoidLineWidth(),t.fillStyle=i.getStrokeStyle(),t.stroke(),t.fillStyle=i.getFillStyle(),t.fill()}getPosition(){return this.position}getVelocity(){return this.velocity}}